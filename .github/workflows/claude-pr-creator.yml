# .github/workflows/claude-pr-creator.yml
name: Claude PR Creator
on:
  issues:
    types: [labeled]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  claude-pr-creator:
    if: contains(github.event.label.name, 'claude-create-pr')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write  # Required for OIDC token
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # Checkout using GitHub App Token
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false


      - name: Generate GitHub App Token
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        id: app-token
        with:
          app-id: ${{ secrets.LIAM_CODE_ASSISTANT_APP_ID }}
          private-key: ${{ secrets.LIAM_CODE_ASSISTANT_PRIVATE_KEY }}
          permission-contents: write
          permission-pull-requests: write
          permission-issues: write
          repositories: liam

      - name: Run Claude Code Action
        uses: anthropics/claude-code-action@91c510a769db0f9b79df0efbdded0c29c033f846 # beta
        id: claude-code
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          github_token: ${{ steps.app-token.outputs.token }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            Please implement based on Issue #${{ env.ISSUE_NUMBER }}:

            Title: ${{ env.ISSUE_TITLE }}

            Content:
            ${{ env.ISSUE_BODY }}

            Please implement with appropriate branch name and commit message.
            Output the branch name when implementation is complete.

      - name: Create Pull Request
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            // Get the branch created by Claude Code Action
            // Claude Code Action creates branches with pattern: claude/issue-<number>-<timestamp>
            const issueNumber = process.env.ISSUE_NUMBER;
            const branches = await github.rest.repos.listBranches({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // Find the branch created for this specific issue
            const claudeBranch = branches.data.find(branch =>
              branch.name.includes(`claude/issue-${issueNumber}`) ||
              branch.name.includes(`issue-${issueNumber}`)
            );

            if (claudeBranch) {
              console.log(`Creating PR for branch: ${claudeBranch.name}`);

              const pr = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Fix: ${process.env.ISSUE_TITLE}`,
                head: claudeBranch.name,
                base: 'main',
                draft: true,
                body: [
                  `Closes #${process.env.ISSUE_NUMBER}`,
                  '',
                  '## Summary',
                  process.env.ISSUE_TITLE,
                  '',
                  '## Implementation Details',
                  process.env.ISSUE_BODY,
                  '',
                  '## Auto-generated',
                  'This PR was automatically generated by Claude Code Action.'
                ].join('\n')
              });

              console.log(`Pull Request created: ${pr.data.html_url}`);

              // Add comment to the issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: process.env.ISSUE_NUMBER,
                body: `ðŸ¤– Pull Request has been automatically created: ${pr.data.html_url}`
              });
            } else {
              console.log('No new branch found to create PR');
            }
